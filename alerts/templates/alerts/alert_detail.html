{% extends "alerts/base.html" %}
{% block extra_css %}
<style>
/* Custom styles for history table */
.table .badge {
    font-size: 0.85em;
}

.ongoing-duration {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}
</style>
{% endblock %}

{% block title %}{{ alert.name }} - SentryHub{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'alerts:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'alerts:alert-list' %}">Alerts</a></li>
                <li class="breadcrumb-item active">{{ alert.name }}</li>
            </ol>
        </nav>
    </div>
</div>

{% if messages %}
<div class="row mb-4">
    <div class="col-12">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Alert: {{ alert.name }}</h5>
                    <div>
                        <a href="{% url 'alerts:alert-history' alert.fingerprint %}" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-clock-history"></i> History
                        </a>
                        {% if not alert.acknowledged %}
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#acknowledgeModal">
                            <i class="bi bi-check-circle"></i> Acknowledge
                        </button>
                        
                        <!-- Acknowledge Modal -->
                        <div class="modal fade" id="acknowledgeModal" tabindex="-1" aria-labelledby="acknowledgeModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="acknowledgeModalLabel">Acknowledge Alert</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form method="post">
                                        <div class="modal-body">
                                            {% csrf_token %}
                                            <p>You are acknowledging the alert: <strong>{{ alert.name }}</strong></p>
                                            <p>Please provide a comment explaining the reason for acknowledgement or any actions being taken:</p>
                                            
                                            <div class="mb-3">
                                                <label for="id_comment" class="form-label">Comment <span class="text-danger">*</span></label>
                                                {{ acknowledge_form.comment }}
                                                <div class="form-text">Required: Please provide details about why you're acknowledging this alert.</div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" name="acknowledge" class="btn btn-primary">Acknowledge Alert</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Alert Details -->
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">Alert Details</h6>
                        <table class="table">
                            <tr>
                                <th style="width: 30%">Status</th>
                                <td>
                                    {% if alert.current_status == 'firing' %}
                                    <span class="badge bg-danger">Firing</span>
                                    {% else %}
                                    <span class="badge bg-success">Resolved</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Severity</th>
                                <td>
                                    {% if alert.severity == 'critical' %}
                                    <span class="badge bg-danger">Critical</span>
                                    {% elif alert.severity == 'warning' %}
                                    <span class="badge bg-warning text-dark">Warning</span>
                                    {% else %}
                                    <span class="badge bg-info text-dark">Info</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>First Occurrence</th>
                                <td>{{ alert.first_occurrence|date:"Y-m-d H:i:s" }}</td>
                            </tr>
                            <tr>
                                <th>Last Occurrence</th>
                                <td>{{ alert.last_occurrence|date:"Y-m-d H:i:s" }}</td>
                            </tr>
                            <tr>
                                <th>Total Firing Count</th>
                                <td>{{ alert.total_firing_count }}</td>
                            </tr>
                            <tr>
                                <th>Acknowledged</th>
                                <td>
                                    {% if alert.acknowledged %}
                                    Yes, by {{ alert.acknowledged_by.username }} at {{ alert.acknowledgement_time|date:"Y-m-d H:i:s" }}
                                    {% else %}
                                    No
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Fingerprint</th>
                                <td><code>{{ alert.fingerprint }}</code></td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Labels and Annotations -->
                    <div class="col-md-6">
                        <h6 class="border-bottom pb-2 mb-3">Labels</h6>
                        <table class="table table-sm mb-4">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key, value in alert.labels.items %}
                                <tr>
                                    <td><code>{{ key }}</code></td>
                                    <td><code>{{ value }}</code></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="2" class="text-center">No labels</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        
                        <h6 class="border-bottom pb-2 mb-3">Latest Annotations</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Key</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% with last_instance=instances.first %}
                                {% if last_instance %}
                                    {% for key, value in last_instance.annotations.items %}
                                    <tr>
                                        <td><code>{{ key }}</code></td>
                                        <td>{{ value }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="2" class="text-center">No annotations</td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="2" class="text-center">No instances</td>
                                </tr>
                                {% endif %}
                                {% endwith %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert History Timeline -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Alert History</h5>
                    <a href="{% url 'alerts:alert-history' alert.fingerprint %}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-clock-history"></i> View Full History
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>Status</th>
                                <th>Started</th>
                                <th>Resolved</th>
                                <th>Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for instance in instances|slice:":10" %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    {% if instance.status == 'firing' and not instance.ended_at %}
                                    <span class="badge bg-danger">Firing</span>
                                    {% else %}
                                    <span class="badge bg-success">Resolved</span>
                                    {% endif %}
                                </td>
                                <td>{{ instance.started_at|date:"Y-m-d H:i:s" }}</td>
                                <td>
                                    {% if instance.ended_at %}
                                    {{ instance.ended_at|date:"Y-m-d H:i:s" }}
                                    {% elif instance.status == 'firing' and not instance.ended_at %}
                                    <span class="badge bg-warning text-dark">Not Resolved Yet</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="{% if instance.status == 'firing' and not instance.ended_at %}text-warning fw-bold{% endif %}">
                                        {% if instance.ended_at %}
                                        <span class="duration" data-start="{{ instance.started_at|date:'c' }}" data-end="{{ instance.ended_at|date:'c' }}">
                                            Calculating...
                                        </span>
                                        {% elif instance.status == 'firing' and not instance.ended_at %}
                                        <span class="ongoing-duration" data-start="{{ instance.started_at|date:'c' }}">
                                            Ongoing
                                        </span>
                                        {% else %}
                                        --
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#instanceModal{{ instance.id }}">
                                        <i class="bi bi-info-circle"></i> Details
                                    </button>
                                    
                                    {% if instance.generator_url %}
                                    <a href="{{ instance.generator_url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-box-arrow-up-right"></i> Prometheus
                                    </a>
                                    {% endif %}
                                    
                                    <!-- Modal for instance details -->
                                    <div class="modal fade" id="instanceModal{{ instance.id }}" tabindex="-1" aria-labelledby="instanceModalLabel{{ instance.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="instanceModalLabel{{ instance.id }}">Alert Instance Details</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <h6>Annotations</h6>
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr>
                                                                <th>Key</th>
                                                                <th>Value</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% for key, value in instance.annotations.items %}
                                                            <tr>
                                                                <td><code>{{ key }}</code></td>
                                                                <td>{{ value }}</td>
                                                            </tr>
                                                            {% empty %}
                                                            <tr>
                                                                <td colspan="2" class="text-center">No annotations</td>
                                                            </tr>
                                                            {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center">No history available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if instances.count > 10 %}
                <div class="text-center mt-3">
                    <a href="{% url 'alerts:alert-history' alert.fingerprint %}" class="btn btn-outline-primary">
                        <i class="bi bi-list"></i> View Complete History ({{ instances.count }} records)
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Comments Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Comments</h5>
            </div>
            <div class="card-body">
                <!-- Comment Form -->
                <form method="post" class="mb-4">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_content" class="form-label">Add a Comment</label>
                        {{ comment_form.content }}
                    </div>
                    <button type="submit" name="comment" class="btn btn-primary">Submit</button>
                </form>
                
                <!-- Comment List -->
                <div class="comments">
                    {% for comment in comments %}
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ comment.user.username }}</strong>
                                </div>
                                <div>
                                    <small class="text-muted">{{ comment.created_at|date:"Y-m-d H:i:s" }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <p class="card-text">{{ comment.content }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <div class="alert alert-info">
                        No comments yet. Be the first to comment!
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Function to format duration
    function formatDuration(seconds) {
        if (seconds < 60) {
            return seconds + " seconds";
        } else if (seconds < 3600) {
            return Math.floor(seconds / 60) + " min " + (seconds % 60) + " sec";
        } else if (seconds < 86400) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return hours + " hr " + minutes + " min";
        } else {
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            return days + " days " + hours + " hr";
        }
    }

    // Calculate durations for completed periods
    document.querySelectorAll('.duration').forEach(function(el) {
        const start = new Date(el.dataset.start);
        const end = new Date(el.dataset.end);
        const duration = Math.floor((end - start) / 1000); // Duration in seconds
        el.textContent = formatDuration(duration);
    });
    
    // Calculate ongoing durations
    document.querySelectorAll('.ongoing-duration').forEach(function(el) {
        const start = new Date(el.dataset.start);
        const now = new Date();
        const duration = Math.floor((now - start) / 1000); // Duration in seconds
        el.textContent = formatDuration(duration) + " (ongoing)";
        
        // Update ongoing duration every minute
        setInterval(function() {
            const currentDuration = Math.floor((new Date() - start) / 1000);
            el.textContent = formatDuration(currentDuration) + " (ongoing)";
        }, 60000);
    });
});
</script>
{% endblock %}